version: "3.9"

x-common: &common
  restart: unless-stopped

services:
  nats:
    <<: *common
    image: nats:2.10-alpine
    command: ["-js", "--http_port", "8222"]
    ports: ["4222:4222", "8222:8222"]
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 3s
      retries: 5

  postgres:
    <<: *common
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: helio
      POSTGRES_PASSWORD: change-me
      POSTGRES_DB: helio
    ports: ["5432:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U helio"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    <<: *common
    image: redis:7-alpine
    ports: ["6379:6379"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  chromadb:
    <<: *common
    image: chromadb/chroma:0.5.0
    ports: ["8000:8000"]

  vault:
    <<: *common
    image: hashicorp/vault:1.17
    command: ["server", "-config=/vault/config/vault.hcl"]
    cap_add: ["IPC_LOCK"]
    volumes:
      - ./infra/vault/vault.hcl:/vault/config/vault.hcl:ro
    ports: ["8200:8200"]

  opa:
    <<: *common
    image: openpolicyagent/opa:latest
    command: ["run", "--server", "--log-level=debug", "/policies/policies.rego"]
    volumes:
      - ./infra/opa/policies.rego:/policies/policies.rego:ro
    ports: ["8181:8181"]

  ollama:
    <<: *common
    image: ollama/ollama:latest
    ports: ["11434:11434"]
    volumes:
      - ollama_data:/root/.ollama

  scout:
    <<: *common
    image: alpine:3.20
    command: ["sh", "-lc", "while true; do echo scout-ready; sleep 3600; done"]

  helio-core:
    <<: *common
    build: ./core/helio
    environment:
      NATS_URL: nats://nats:4222
      DATABASE_URL: postgres://helio:change-me@postgres:5432/helio
    depends_on:
      nats:
        condition: service_healthy
      postgres:
        condition: service_healthy
    ports: ["3000:3000"]

  telegram-bot:
    <<: *common
    build: ./apps/telegram-bot
    environment:
      NATS_URL: nats://nats:4222
      TELEGRAM_BOT_TOKEN: YOUR_TELEGRAM_TOKEN_HERE
    depends_on:
      nats:
        condition: service_healthy

  web:
    <<: *common
    build: ./apps/web
    depends_on: [helio-core]
    ports: ["5173:5173"]

  sfu-rs:
    <<: *common
    build: ./microservices/sfu
    environment:
      NATS_URL: nats://nats:4222
    depends_on:
      nats:
        condition: service_healthy

  crdt-sync-rs:
    <<: *common
    build: ./microservices/crdt-sync
    environment:
      NATS_URL: nats://nats:4222
    depends_on:
      nats:
        condition: service_healthy

  reporting-rs:
    <<: *common
    build: ./microservices/reporting
    environment:
      NATS_URL: nats://nats:4222
    depends_on:
      nats:
        condition: service_healthy

volumes:
  ollama_data:
