version: "3.9"

x-common: &common
  restart: unless-stopped

services:
  nats:
    <<: *common
    image: nats:2.10-alpine
    command: ["-c", "/etc/nats/nats.conf"]
    volumes:
      - ./infra/nats/nats.conf:/etc/nats/nats.conf:ro
    ports: ["4222:4222", "8222:8222"]
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 3s
      retries: 5

  postgres:
    <<: *common
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: helio
      POSTGRES_PASSWORD: helio
      POSTGRES_DB: helio
    ports: ["5432:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U helio"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    <<: *common
    image: redis:7-alpine
    ports: ["6379:6379"]

  chromadb:
    <<: *common
    image: chromadb/chroma:0.5.0
    ports: ["8000:8000"]

  vault:
    <<: *common
    image: hashicorp/vault:1.17
    command: ["server", "-config=/vault/config/vault.hcl"]
    cap_add: ["IPC_LOCK"]
    volumes:
      - ./infra/vault/vault.hcl:/vault/config/vault.hcl:ro
    ports: ["8200:8200"]

  ollama:
    <<: *common
    image: ollama/ollama:latest
    ports: ["11434:11434"]

  scout:
    <<: *common
    image: alpine:3.20
    command: ["sh", "-lc", "while true; do echo scout-ready; sleep 3600; done"]

  helio-core:
    <<: *common
    build: ./core/helio
    environment:
      NATS_URL: nats://nats:4222
      DATABASE_URL: postgres://helio:helio@postgres:5432/helio
    depends_on:
      nats:
        condition: service_healthy
      postgres:
        condition: service_healthy
    ports: ["3000:3000"]

  web:
    <<: *common
    build: ./apps/web
    depends_on: [helio-core]
    ports: ["5173:5173"]

  telegram-bot:
    <<: *common
    build: ./apps/telegram-bot
    environment:
      NATS_URL: nats://nats:4222
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-change-me}
    depends_on: [nats, helio-core]

  sfu-rs:
    <<: *common
    build: ./microservices/sfu-rs
    environment:
      NATS_URL: nats://nats:4222
    depends_on: [nats]

  crdt-sync-rs:
    <<: *common
    build: ./microservices/crdt-sync-rs
    environment:
      NATS_URL: nats://nats:4222
    depends_on: [nats]

  reporting-rs:
    <<: *common
    build: ./microservices/reporting-rs
    environment:
      NATS_URL: nats://nats:4222
    depends_on: [nats]

  authz-rs:
    <<: *common
    build: ./microservices/authz-rs
    environment:
      NATS_URL: nats://nats:4222
    depends_on: [nats]
