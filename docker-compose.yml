version: "3.9"

services:
  nats:
    image: nats:2.10-alpine
    command: ["-c", "/etc/nats/nats.conf"]
    volumes:
      - ./infra/nats/nats.conf:/etc/nats/nats.conf:ro
    ports:
      - "4222:4222"
      - "8222:8222"

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: helio
      POSTGRES_PASSWORD: helio
      POSTGRES_DB: helio
    ports: ["5432:5432"]

  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]

  chromadb:
    image: chromadb/chroma:0.5.0
    ports: ["8000:8000"]

  vault:
    image: hashicorp/vault:1.17
    command: ["server", "-config=/vault/config/vault.hcl"]
    cap_add: ["IPC_LOCK"]
    volumes:
      - ./infra/vault/vault.hcl:/vault/config/vault.hcl:ro
    ports: ["8200:8200"]

  ollama:
    image: ollama/ollama:latest
    ports: ["11434:11434"]

  scout:
    image: alpine:3.20
    command: ["sh", "-lc", "while true; do echo scout-ready; sleep 3600; done"]

  helio-core:
    build: ./core/helio
    environment:
      NATS_URL: nats://nats:4222
      DATABASE_URL: postgres://helio:helio@postgres:5432/helio
    depends_on: [nats, postgres, redis]
    ports: ["3000:3000"]

  web:
    build: ./apps/web
    depends_on: [helio-core]
    ports: ["5173:5173"]

  telegram-bot:
    build: ./apps/telegram-bot
    environment:
      NATS_URL: nats://nats:4222
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-dev-token}
    depends_on: [nats, helio-core]

  sfu-rs:
    build: ./microservices/sfu-rs
    environment:
      NATS_URL: nats://nats:4222
    depends_on: [nats]

  crdt-sync-rs:
    build: ./microservices/crdt-sync-rs
    environment:
      NATS_URL: nats://nats:4222
    depends_on: [nats]

  reporting-rs:
    build: ./microservices/reporting-rs
    environment:
      NATS_URL: nats://nats:4222
    depends_on: [nats]

  authz-rs:
    build: ./microservices/authz-rs
    environment:
      NATS_URL: nats://nats:4222
    depends_on: [nats]
